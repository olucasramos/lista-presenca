<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chamada</title>
<style>
  * {
    box-sizing: border-box;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #2980b9, #6dd5fa);
    color: #fff;
    margin: 0;
    padding: 20px 15px 80px 15px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  header {
    width: 100%;
    max-width: 400px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    justify-content: flex-start;
  }
  a.btn-voltar {
    cursor: pointer;
    background-color: #154360;
    color: white;
    text-decoration: none;
    padding: 8px 16px;
    border-radius: 12px;
    font-weight: 600;
    box-shadow: 0 4px 10px rgba(21,67,96,0.7);
    transition: background-color 0.25s ease, box-shadow 0.25s ease;
  }
  a.btn-voltar:hover {
    background-color: #0e2a48;
    box-shadow: 0 6px 14px rgba(14, 42, 72, 0.9);
  }
  h1 {
    font-size: 2.4rem;
    margin: 0 0 18px 0;
    text-shadow: 0 2px 6px rgba(0,0,0,0.25);
    line-height: 1.2;
    text-align: center;
    max-width: 400px;
    width: 100%;
  }
  .data-container {
    background-color: rgba(21, 67, 96, 0.85);
    border-radius: 12px;
    padding: 12px 20px;
    margin-bottom: 20px;
    max-width: 400px;
    width: 100%;
    box-shadow: 0 6px 14px rgba(21, 67, 96, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: 600;
    font-size: 1.1rem;
  }
  input[type="date"] {
    background-color: white;
    color: #154360;
    border-radius: 8px;
    border: none;
    padding: 8px 14px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 3px 7px rgba(0,0,0,0.15);
  }
  .funcionario-lista {
    max-width: 400px;
    width: 100%;
  }
  .funcionario-card {
    background-color: rgba(21, 67, 96, 0.85);
    border-radius: 12px;
    padding: 14px 18px;
    margin-bottom: 14px;
    box-shadow: 0 6px 14px rgba(21, 67, 96, 0.7);
    user-select: none;
  }
  .funcionario-card h3 {
    margin: 0 0 8px 0;
    font-weight: 700;
    font-size: 1.2rem;
    user-select: text;
  }
  .opcoes-presenca {
    display: flex;
    gap: 10px;
    margin-top: 6px;
    user-select: none;
  }
  .opcoes-presenca label {
    background-color: #2980b9;
    border-radius: 10px;
    padding: 6px 12px;
    cursor: pointer;
    user-select: none;
    font-weight: 600;
    transition: background-color 0.25s ease;
  }
  .opcoes-presenca input[type="radio"] {
    display: none;
  }
  .opcoes-presenca input[type="radio"]:checked + label {
    background-color: #1c5d8e;
  }
  .atestado-container {
    margin-top: 6px;
    padding-left: 18px;
  }
  .btn-salvar {
    display: block;
    margin: 20px auto 0 auto;
    background-color: #2ecc71;
    color: white;
    font-weight: 700;
    padding: 12px 28px;
    font-size: 1.1rem;
    border: none;
    border-radius: 16px;
    box-shadow: 0 6px 14px rgba(46, 204, 113, 0.7);
    cursor: pointer;
    transition: background-color 0.3s ease;
    max-width: 400px;
    width: 100%;
  }
  .btn-salvar:hover {
    background-color: #27ae60;
  }
  footer {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 400px;
    background-color: rgba(21, 67, 96, 0.85);
    color: white;
    text-align: center;
    padding: 10px 0;
    font-weight: 600;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: 0.9rem;
    box-shadow: 0 -2px 6px rgba(0,0,0,0.2);
    user-select: none;
  }
</style>
</head>
<body>

<header>
  <a href="index.html" class="btn-voltar">⬅ Voltar</a>
</header>

<h1>Chamada</h1>

<div class="data-container">
  <label for="dataChamada" style="margin-right: 12px;">Data:</label>
  <input type="date" id="dataChamada" />
</div>

<div class="funcionario-lista" id="listaFuncionarios">
  <!-- Funcionários serão listados aqui -->
</div>

<button class="btn-salvar" id="btnSalvar">Salvar Chamada</button>

<footer>
  Desenvolvido por Lucas Ramos Aragão
</footer>

<script type="module">
  import { db, ref, set, get, child } from './firebase.js';

  const dataChamadaInput = document.getElementById('dataChamada');
  const listaFuncionariosDiv = document.getElementById('listaFuncionarios');
  const btnSalvar = document.getElementById('btnSalvar');

  // Função para formatar data para DD/MM/AAAA
  function formatarDataBr(dateStr) {
    const [year, month, day] = dateStr.split('-');
    return `${day}/${month}/${year}`;
  }

  // Define a data padrão como hoje no input date
  function setDataHoje() {
    const hoje = new Date();
    const yyyy = hoje.getFullYear();
    const mm = String(hoje.getMonth() + 1).padStart(2, '0');
    const dd = String(hoje.getDate()).padStart(2, '0');
    dataChamadaInput.value = `${yyyy}-${mm}-${dd}`;
  }

  // Carrega funcionários e exibe cards para chamada
  async function carregarFuncionarios() {
    listaFuncionariosDiv.innerHTML = 'Carregando...';
    try {
      const snapshot = await get(ref(db, 'funcionarios'));
      if (!snapshot.exists()) {
        listaFuncionariosDiv.innerHTML = 'Nenhum funcionário cadastrado.';
        return;
      }
      const funcionarios = snapshot.val();
      listaFuncionariosDiv.innerHTML = '';

      Object.entries(funcionarios).forEach(([id, f]) => {
        const card = document.createElement('div');
        card.classList.add('funcionario-card');

        const nome = document.createElement('h3');
        nome.textContent = f.nome;
        card.appendChild(nome);

        const opcoes = document.createElement('div');
        opcoes.classList.add('opcoes-presenca');

        // Presente
        const presenteId = `presente-${id}`;
        const presenteInput = document.createElement('input');
        presenteInput.type = 'radio';
        presenteInput.name = `presenca-${id}`;
        presenteInput.id = presenteId;
        presenteInput.value = 'presente';

        const presenteLabel = document.createElement('label');
        presenteLabel.htmlFor = presenteId;
        presenteLabel.textContent = 'Presente';

        // Falta
        const faltaId = `falta-${id}`;
        const faltaInput = document.createElement('input');
        faltaInput.type = 'radio';
        faltaInput.name = `presenca-${id}`;
        faltaInput.id = faltaId;
        faltaInput.value = 'falta';

        const faltaLabel = document.createElement('label');
        faltaLabel.htmlFor = faltaId;
        faltaLabel.textContent = 'Faltou';

        opcoes.appendChild(presenteInput);
        opcoes.appendChild(presenteLabel);
        opcoes.appendChild(faltaInput);
        opcoes.appendChild(faltaLabel);

        card.appendChild(opcoes);

        // Se funcionário, adicionar opção atestado que aparece só se marcou falta
        if (f.tipo === 'funcionario') {
          const atestadoDiv = document.createElement('div');
          atestadoDiv.classList.add('atestado-container');
          atestadoDiv.style.display = 'none';

          const atestadoSimId = `atestado-sim-${id}`;
          const atestadoNaoId = `atestado-nao-${id}`;

          const labelAtestado = document.createElement('label');
          labelAtestado.textContent = 'Atestado:';

          const atestadoSimInput = document.createElement('input');
          atestadoSimInput.type = 'radio';
          atestadoSimInput.name = `atestado-${id}`;
          atestadoSimInput.id = atestadoSimId;
          atestadoSimInput.value = 'com atestado';

          const atestadoSimLabel = document.createElement('label');
          atestadoSimLabel.htmlFor = atestadoSimId;
          atestadoSimLabel.textContent = 'Com atestado';

          const atestadoNaoInput = document.createElement('input');
          atestadoNaoInput.type = 'radio';
          atestadoNaoInput.name = `atestado-${id}`;
          atestadoNaoInput.id = atestadoNaoId;
          atestadoNaoInput.value = 'sem atestado';

          const atestadoNaoLabel = document.createElement('label');
          atestadoNaoLabel.htmlFor = atestadoNaoId;
          atestadoNaoLabel.textContent = 'Sem atestado';

          atestadoDiv.appendChild(labelAtestado);
          atestadoDiv.appendChild(atestadoSimInput);
          atestadoDiv.appendChild(atestadoSimLabel);
          atestadoDiv.appendChild(atestadoNaoInput);
          atestadoDiv.appendChild(atestadoNaoLabel);

          card.appendChild(atestadoDiv);

          // Mostrar/ocultar atestado quando marca falta
          faltaInput.addEventListener('change', () => {
            atestadoDiv.style.display = 'block';
          });
          presenteInput.addEventListener('change', () => {
            atestadoDiv.style.display = 'none';
            // Limpa seleção de atestado
            const radios = atestadoDiv.querySelectorAll('input[type="radio"]');
            radios.forEach(r => r.checked = false);
          });
        }

        listaFuncionariosDiv.appendChild(card);
      });
    } catch (error) {
      listaFuncionariosDiv.innerHTML = 'Erro ao carregar funcionários.';
      console.error(error);
    }
  }

  btnSalvar.addEventListener('click', async () => {
    const dataSelecionada = dataChamadaInput.value;
    if (!dataSelecionada) {
      alert('Por favor, selecione uma data.');
      return;
    }

    const snapshot = await get(ref(db, 'funcionarios'));
    if (!snapshot.exists()) {
      alert('Nenhum funcionário cadastrado.');
      return;
    }

    const funcionarios = snapshot.val();
    const updates = {};

    let erroAtestado = false;

    Object.entries(funcionarios).forEach(([id, f]) => {
      const presencaRadios = document.getElementsByName(`presenca-${id}`);
      let presencaSelecionada = null;
      presencaRadios.forEach(r => {
        if (r.checked) presencaSelecionada = r.value;
      });

      if (!presencaSelecionada) {
        // Se não marcou, considera ausente sem atestado para funcionário
        presencaSelecionada = 'presente'; // ou talvez avisar que falta seleção?
      }

      if (f.tipo === 'funcionario' && presencaSelecionada === 'falta') {
        const atestadoRadios = document.getElementsByName(`atestado-${id}`);
        let atestadoSelecionado = null;
        atestadoRadios.forEach(r => {
          if (r.checked) atestadoSelecionado = r.value;
        });
        if (!atestadoSelecionado) {
          erroAtestado = true;
        }
        updates[`chamada/${dataSelecionada}/${id}`] = {
          nome: f.nome,
          tipo: f.tipo,
          presenca: presencaSelecionada,
          atestado: atestadoSelecionado || ''
        };
      } else {
        updates[`chamada/${dataSelecionada}/${id}`] = {
          nome: f.nome,
          tipo: f.tipo,
          presenca: presencaSelecionada
        };
      }
    });

    if (erroAtestado) {
      alert('Funcionário marcado como falta deve informar se apresentou atestado ou não.');
      return;
    }

    try {
      await set(ref(db), updates);
      alert('Chamada salva com sucesso!');
    } catch (error) {
      alert('Erro ao salvar chamada.');
      console.error(error);
    }
  });

  // Inicializa
  setDataHoje();
  carregarFuncionarios();
</script>

</body>
</html>
