<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Funcionários</title>
  <style>
    /* estilos mantidos iguais */
  </style>
</head>
<body>

  <header>
    <a href="index.html" class="btn-voltar">⬅ Voltar</a>
  </header>

  <h1>Funcionários</h1>

  <form id="formFuncionario" autocomplete="off">
    <label for="nome">Nome</label>
    <input type="text" id="nome" required />

    <label>Tipo</label>
    <div class="radio-group">
      <label><input type="radio" name="tipo" value="funcionario" checked> Funcionário</label>
      <label><input type="radio" name="tipo" value="diarista"> Diarista</label>
    </div>

    <!-- Função -->
    <label for="funcao">Função</label>
    <select id="funcao" required>
      <option value="" disabled selected>Selecione a função</option>
      <option value="Ajudante Prático">Ajudante Prático</option>
      <option value="Oficial">Oficial</option>
      <option value="Oficial Pleno">Oficial Pleno</option>
      <option value="Oficial Polivalente">Oficial Polivalente</option>
      <option value="Encarregado">Encarregado</option>
      <option value="Outro">Outro</option>
    </select>

    <div id="funcaoOutroGroup">
      <label for="funcaoOutro">Especifique a função</label>
      <input type="text" id="funcaoOutro" placeholder="Digite a função" />
    </div>

    <div id="funcionarioCampos">
      <label for="obra">Obra</label>
      <input type="text" id="obra" />
    </div>

    <div id="diaristaCampos" style="display:none;">
      <label for="cpf">CPF</label>
      <input type="text" id="cpf" placeholder="000.000.000-00" maxlength="14" />

      <label for="tipoPix">Tipo de Chave PIX</label>
      <select id="tipoPix">
        <option value="" disabled selected>Selecione o tipo de chave PIX</option>
        <option value="CPF">CPF</option>
        <option value="CNPJ">CNPJ</option>
        <option value="Email">Email</option>
        <option value="Telefone">Telefone</option>
        <option value="Aleatória">Chave Aleatória</option>
      </select>

      <label for="chavePix">Chave PIX</label>
      <input type="text" id="chavePix" />

      <label for="banco">Banco</label>
      <input type="text" id="banco" />

      <label for="valorDiaria">Valor da diária (R$)</label>
      <input type="number" id="valorDiaria" min="0" step="1" />

      <label for="obraDiarista">Obra</label>
      <input type="text" id="obraDiarista" />
    </div>

    <button type="submit" class="btn-salvar">Salvar Funcionário</button>
  </form>

  <div class="funcionario-lista" id="listaFuncionarios"></div>

  <footer>
    Desenvolvido por Lucas Ramos Aragão
  </footer>

  <script type="module">
    import { db, ref, set, get, update, remove, push } from "./firebase.js";

    const form = document.getElementById('formFuncionario');
    const tipoRadios = document.getElementsByName('tipo');
    const funcionarioCampos = document.getElementById('funcionarioCampos');
    const diaristaCampos = document.getElementById('diaristaCampos');
    const funcaoSelect = document.getElementById('funcao');
    const funcaoOutroGroup = document.getElementById('funcaoOutroGroup');
    const funcaoOutroInput = document.getElementById('funcaoOutro');
    const listaFuncionarios = document.getElementById('listaFuncionarios');

    let funcionarios = {};
    let editandoId = null;

    function formatarCPF(cpf) {
      return cpf
        .replace(/\D/g, '')
        .replace(/(\d{3})(\d)/, '$1.$2')
        .replace(/(\d{3})(\d)/, '$1.$2')
        .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    }

    function mostrarCamposPorTipo() {
      const tipoSelecionado = [...tipoRadios].find(r => r.checked).value;
      if (tipoSelecionado === 'funcionario') {
        funcionarioCampos.style.display = 'block';
        diaristaCampos.style.display = 'none';
        form.obra.required = true;
        form.obraDiarista.required = false;
      } else {
        funcionarioCampos.style.display = 'none';
        diaristaCampos.style.display = 'block';
        form.obra.required = false;
        form.obraDiarista.required = true;
      }
    }

    funcaoSelect.addEventListener('change', () => {
      if (funcaoSelect.value === 'Outro') {
        funcaoOutroGroup.style.display = 'block';
        funcaoOutroInput.required = true;
      } else {
        funcaoOutroGroup.style.display = 'none';
        funcaoOutroInput.required = false;
      }
    });

    tipoRadios.forEach(radio => {
      radio.addEventListener('change', mostrarCamposPorTipo);
    });

    diaristaCampos.querySelector('#cpf').addEventListener('input', e => {
      e.target.value = formatarCPF(e.target.value);
    });

    form.addEventListener('submit', async e => {
      e.preventDefault();

      const nome = form.nome.value.trim();
      const tipo = [...tipoRadios].find(r => r.checked).value;
      let dadosFuncionario = { nome, tipo };

      let funcao = funcaoSelect.value;
      if (funcao === 'Outro') {
        funcao = funcaoOutroInput.value.trim();
        if (!funcao) {
          alert('Por favor, especifique a função.');
          return;
        }
      }
      dadosFuncionario.funcao = funcao;

      if (tipo === 'funcionario') {
        const obra = form.obra.value.trim();
        if (!nome || !funcao || !obra) {
          alert('Por favor, preencha todos os campos obrigatórios.');
          return;
        }
        dadosFuncionario.obra = obra;
      } else {
        const cpf = form.cpf.value.trim();
        const tipoPix = form.tipoPix.value.trim();
        const chavePix = form.chavePix.value.trim();
        const banco = form.banco.value.trim();
        const valorDiaria = form.valorDiaria.value.trim();
        const obraDiarista = form.obraDiarista.value.trim();

        if (!nome || !cpf || !valorDiaria || !obraDiarista) {
          alert('Por favor, preencha os campos obrigatórios do diarista.');
          return;
        }

        dadosFuncionario.cpf = cpf;
        dadosFuncionario.tipoPix = tipoPix;
        dadosFuncionario.chavePix = chavePix;
        dadosFuncionario.banco = banco;
        dadosFuncionario.valorDiaria = parseInt(valorDiaria, 10);
        dadosFuncionario.obra = obraDiarista;
      }

      try {
        if (editandoId) {
          await update(ref(db, `funcionarios/${editandoId}`), dadosFuncionario);
          alert('Funcionário atualizado com sucesso!');
          editandoId = null;
        } else {
          const novoRef = push(ref(db, 'funcionarios'));
          await set(novoRef, dadosFuncionario);
          alert('Funcionário cadastrado com sucesso!');
        }
        form.reset();
        funcaoOutroGroup.style.display = 'none';
        mostrarCamposPorTipo();
        carregarFuncionarios();
      } catch (error) {
        console.error('Erro ao salvar funcionário:', error);
        alert('Erro ao salvar funcionário. Veja o console para detalhes.');
      }
    });

    async function carregarFuncionarios() {
      try {
        const snapshot = await get(ref(db, 'funcionarios'));
        if (snapshot.exists()) {
          funcionarios = snapshot.val();
          montarLista();
        } else {
          listaFuncionarios.innerHTML = '<p>Nenhum funcionário encontrado.</p>';
        }
      } catch (error) {
        console.error('Erro ao carregar funcionários:', error);
        listaFuncionarios.innerHTML = '<p>Erro ao carregar funcionários.</p>';
      }
    }

    function montarLista() {
      listaFuncionarios.innerHTML = '';
      const funcionariosOrdenados = Object.entries(funcionarios)
        .sort(([, a], [, b]) => a.nome.localeCompare(b.nome, 'pt-BR', { sensitivity: 'base' }));

      for (const [id, f] of funcionariosOrdenados) {
        let info = `Tipo: ${capitalize(f.tipo)}\n`;
        if (f.tipo.toLowerCase() === 'funcionario') {
          info += `Função: ${f.funcao}\nObra: ${f.obra}`;
        } else if (f.tipo.toLowerCase() === 'diarista') {
          info += `CPF: ${f.cpf}\nChave PIX: ${f.chavePix}\nTipo PIX: ${f.tipoPix}\nBanco: ${f.banco}\nValor da diária: R$ ${Number(f.valorDiaria).toFixed(2)}\nObra: ${f.obra}`;
        }

        const card = document.createElement('div');
        card.className = 'funcionario-card';
        card.innerHTML = `
          <div class="funcionario-nome">${f.nome}</div>
          <div class="funcionario-info">${info.replace(/\n/g, '<br>')}</div>
          <div class="btn-actions">
            <button class="btn-editar" data-id="${id}">Editar</button>
            <button class="btn-excluir" data-id="${id}">Excluir</button>
          </div>
        `;

        listaFuncionarios.appendChild(card);
      }

      listaFuncionarios.querySelectorAll('.btn-editar').forEach(btn => {
        btn.addEventListener('click', () => {
          editarFuncionario(btn.dataset.id);
        });
      });
      listaFuncionarios.querySelectorAll('.btn-excluir').forEach(btn => {
        btn.addEventListener('click', () => {
          excluirFuncionario(btn.dataset.id);
        });
      });
    }

    function editarFuncionario(id) {
      const f = funcionarios[id];
      if (!f) return;

      editandoId = id;
      form.nome.value = f.nome;

      if (f.tipo.toLowerCase() === 'funcionario') {
        funcionarioCampos.style.display = 'block';
        diaristaCampos.style.display = 'none';
        form.obra.value = f.obra || '';
      } else {
        funcionarioCampos.style.display = 'none';
        diaristaCampos.style.display = 'block';
        form.cpf.value = f.cpf || '';
        form.tipoPix.value = f.tipoPix || '';
        form.chavePix.value = f.chavePix || '';
        form.banco.value = f.banco || '';
        form.valorDiaria.value = f.valorDiaria || '';
        form.obraDiarista.value = f.obra || '';
      }

      if (f.funcao) {
        const opcoes = Array.from(funcaoSelect.options).map(opt => opt.value);
        if (opcoes.includes(f.funcao)) {
          funcaoSelect.value = f.funcao;
          funcaoOutroGroup.style.display = 'none';
          funcaoOutroInput.value = '';
          funcaoOutroInput.required = false;
        } else {
          funcaoSelect.value = 'Outro';
          funcaoOutroGroup.style.display = 'block';
          funcaoOutroInput.value = f.funcao;
          funcaoOutroInput.required = true;
        }
      } else {
        funcaoSelect.value = '';
        funcaoOutroGroup.style.display = 'none';
        funcaoOutroInput.value = '';
        funcaoOutroInput.required = false;
      }

      tipoRadios.forEach(radio => {
        radio.checked = radio.value === f.tipo;
      });
    }

    async function excluirFuncionario(id) {
      if (confirm('Deseja realmente excluir este funcionário?')) {
        try {
          await remove(ref(db, `funcionarios/${id}`));
          alert('Funcionário excluído com sucesso!');
          carregarFuncionarios();
        } catch (error) {
          console.error('Erro ao excluir funcionário:', error);
          alert('Erro ao excluir funcionário. Veja o console para detalhes.');
        }
      }
    }

    function capitalize(text) {
      if (!text) return '';
      return text.charAt(0).toUpperCase() + text.slice(1);
    }

    mostrarCamposPorTipo();
    carregarFuncionarios();

  </script>

</body>
</html>
