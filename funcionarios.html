<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Funcionários</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #2980b9, #6dd5fa);
      color: #fff;
      margin: 0;
      min-height: 100vh;
      padding: 20px 15px 60px 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    header {
      width: 100%;
      max-width: 400px;
      margin: 0 auto 12px auto;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      user-select: none;
    }
    a.btn-voltar {
      cursor: pointer;
      background-color: #154360;
      color: white;
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 12px;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(21,67,96,0.7);
      transition: background-color 0.25s ease, box-shadow 0.25s ease;
      user-select: none;
    }
    a.btn-voltar:hover {
      background-color: #0e2a48;
      box-shadow: 0 6px 14px rgba(14, 42, 72, 0.9);
    }
    h1 {
      font-size: 2.4rem;
      margin: 0 0 20px 0;
      text-shadow: 0 2px 6px rgba(0,0,0,0.25);
      user-select: none;
      line-height: 1.2;
      text-align: center;
      max-width: 400px;
      width: 100%;
    }
    form {
      background-color: rgba(21, 67, 96, 0.85);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 12px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 6px 14px rgba(21, 67, 96, 0.7);
      user-select: none;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      user-select: none;
    }
    input[type="text"],
    input[type="number"],
    input[type="cpf"],
    input[type="tel"],
    select {
      width: 100%;
      padding: 8px 10px;
      margin-bottom: 15px;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
      font-family: inherit;
    }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    .radio-group {
      margin-bottom: 15px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    .radio-group label {
      font-weight: 500;
      cursor: pointer;
      user-select: none;
    }
    .btn-salvar {
      background-color: #4caf50;
      padding: 14px 0;
      border-radius: 12px;
      font-size: 1.2rem;
      font-weight: 600;
      color: white;
      border: none;
      box-shadow: 0 5px 12px rgba(76, 175, 80, 0.7);
      cursor: pointer;
      transition: background-color 0.25s ease, box-shadow 0.25s ease;
      user-select: none;
      width: 100%;
      margin-top: 10px;
    }
    .btn-salvar:hover {
      background-color: #388e3c;
      box-shadow: 0 7px 18px rgba(56, 142, 60, 0.9);
    }
    .funcionario-lista {
      width: 100%;
      max-width: 400px;
      margin-top: 10px;
      user-select: none;
    }
    .funcionario-card {
      background-color: rgba(21, 67, 96, 0.85);
      border-radius: 12px;
      padding: 16px 18px;
      margin-bottom: 15px;
      box-shadow: 0 6px 14px rgba(21, 67, 96, 0.7);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .funcionario-nome {
      font-weight: 700;
      font-size: 1.1rem;
    }
    .funcionario-info {
      font-size: 0.9rem;
      color: #ddd;
      white-space: pre-line;
    }
    .btn-actions {
      margin-top: 8px;
      display: flex;
      gap: 8px;
    }
    button.btn-editar,
    button.btn-excluir {
      padding: 6px 14px;
      font-size: 0.9rem;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      user-select: none;
      flex: 1;
      transition: background-color 0.2s ease;
    }
    button.btn-editar {
      background-color: #2980b9;
      color: white;
      box-shadow: 0 4px 10px rgba(41,128,185,0.7);
    }
    button.btn-editar:hover {
      background-color: #1f6396;
      box-shadow: 0 6px 14px rgba(31, 99, 150, 0.9);
    }
    button.btn-excluir {
      background-color: #c0392b;
      color: white;
      box-shadow: 0 4px 10px rgba(192,57,43,0.7);
    }
    button.btn-excluir:hover {
      background-color: #8e261e;
      box-shadow: 0 6px 14px rgba(142, 38, 30, 0.9);
    }
    /* Ocultar campo função quando "Outro" não selecionado */
    #funcaoOutroGroup {
      display: none;
      margin-bottom: 15px;
    }
    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(21, 67, 96, 0.9);
      color: #ddd;
      text-align: center;
      font-size: 0.85rem;
      padding: 8px 0;
      user-select: none;
      box-shadow: 0 -2px 6px rgba(0,0,0,0.3);
      max-width: 100%;
    }
    #listaFuncionariosConsultados {
      width: 100%;
      max-width: 400px;
      background-color: rgba(21, 67, 96, 0.75);
      border-radius: 10px;
      padding: 10px 14px;
      margin-bottom: 20px;
      box-shadow: 0 4px 10px rgba(21, 67, 96, 0.6);
      font-size: 0.9rem;
      color: #cce6ff;
      user-select: none;
      min-height: 32px;
      line-height: 1.3;
      font-weight: 600;
    }
    @media (max-width: 420px) {
      h1 {
        font-size: 2rem;
      }
      form {
        padding: 18px 15px;
      }
      input[type="text"],
      input[type="number"],
      select {
        font-size: 1rem;
      }
      .btn-salvar {
        font-size: 1.1rem;
        padding: 14px 0;
      }
      .funcionario-card {
        padding: 14px 16px;
      }
      .funcionario-nome {
        font-size: 1rem;
      }
      button.btn-editar,
      button.btn-excluir {
        font-size: 0.85rem;
        padding: 6px 12px;
      }
    }
  </style>
</head>
<body>

  <header>
    <a href="index.html" class="btn-voltar">⬅ Voltar</a>
  </header>

  <h1>Funcionários</h1>

  <form id="formFuncionario" autocomplete="off">
    <label for="nome">Nome</label>
    <input type="text" id="nome" required />

    <label>Tipo</label>
    <div class="radio-group">
      <label><input type="radio" name="tipo" value="funcionario" checked> Funcionário</label>
      <label><input type="radio" name="tipo" value="diarista"> Diarista</label>
    </div>

    <div id="funcionarioCampos">
      <label for="funcao">Função</label>
      <select id="funcao" required>
        <option value="" disabled selected>Selecione a função</option>
        <option value="Ajudante Prático">Ajudante Prático</option>
        <option value="Oficial">Oficial</option>
        <option value="Oficial Pleno">Oficial Pleno</option>
        <option value="Oficial Polivalente">Oficial Polivalente</option>
        <option value="Encarregado">Encarregado</option>
        <option value="Outro">Outro</option>
      </select>

      <div id="funcaoOutroGroup">
        <label for="funcaoOutro">Especifique a função</label>
        <input type="text" id="funcaoOutro" placeholder="Digite a função" />
      </div>

      <label for="obra">Obra</label>
      <input type="text" id="obra" required />
    </div>

    <div id="diaristaCampos" style="display:none;">
      <label for="cpf">CPF</label>
      <input type="text" id="cpf" placeholder="000.000.000-00" maxlength="14" />

      <label for="tipoPix">Tipo de Chave PIX</label>
      <input type="text" id="tipoPix" />

      <label for="chavePix">Chave PIX</label>
      <input type="text" id="chavePix" />

      <label for="banco">Banco</label>
      <input type="text" id="banco" />

      <label for="valorDiaria">Valor da diária (R$)</label>
      <input type="number" id="valorDiaria" min="0" step="0.01" />
      
      <label for="obraDiarista">Obra</label>
      <input type="text" id="obraDiarista" />
    </div>

    <button type="submit" class="btn-salvar">Salvar Funcionário</button>
  </form>

  <!-- Nova div para lista de funcionários consultados -->
  <div id="listaFuncionariosConsultados">Nenhum funcionário salvo ainda.</div>

  <div class="funcionario-lista" id="listaFuncionarios"></div>

  <footer>
    Desenvolvido por Lucas Ramos Aragão
  </footer>

  <script type="module">
    import { db, ref, set, get, child, update, remove } from "./firebase.js";

    const form = document.getElementById('formFuncionario');
    const tipoRadios = document.getElementsByName('tipo');
    const funcionarioCampos = document.getElementById('funcionarioCampos');
    const diaristaCampos = document.getElementById('diaristaCampos');
    const funcaoSelect = document.getElementById('funcao');
    const funcaoOutroGroup = document.getElementById('funcaoOutroGroup');
    const funcaoOutroInput = document.getElementById('funcaoOutro');
    const listaFuncionarios = document.getElementById('listaFuncionarios');
    const listaFuncionariosConsultados = document.getElementById('listaFuncionariosConsultados');

    let funcionarios = {};
    let editandoId = null;

    // Set para armazenar nomes já salvos
    const nomesSalvosSet = new Set();

    function atualizarListaConsultados() {
      const nomes = Array.from(nomesSalvosSet).sort((a, b) => a.localeCompare(b));
      if (nomes.length === 0) {
        listaFuncionariosConsultados.textContent = 'Nenhum funcionário salvo ainda.';
      } else {
        listaFuncionariosConsultados.textContent = 'Funcionários salvos: ' + nomes.join(', ');
      }
    }

    function formatarCPF(cpf) {
      // Formata CPF no formato NNN.NNN.NNN-NN
      return cpf
        .replace(/\D/g, '')
        .replace(/(\d{3})(\d)/, '$1.$2')
        .replace(/(\d{3})(\d)/, '$1.$2')
        .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    }

    function mostrarCamposPorTipo() {
      const tipoSelecionado = [...tipoRadios].find(r => r.checked).value;
      if (tipoSelecionado === 'funcionario') {
        funcionarioCampos.style.display = 'block';
        diaristaCampos.style.display = 'none';
      } else {
        funcionarioCampos.style.display = 'none';
        diaristaCampos.style.display = 'block';
      }
    }

    funcaoSelect.addEventListener('change', () => {
      if (funcaoSelect.value === 'Outro') {
        funcaoOutroGroup.style.display = 'block';
        funcaoOutroInput.required = true;
      } else {
        funcaoOutroGroup.style.display = 'none';
        funcaoOutroInput.required = false;
      }
    });

    tipoRadios.forEach(radio => {
      radio.addEventListener('change', mostrarCamposPorTipo);
    });

    diaristaCampos.querySelector('#cpf').addEventListener('input', e => {
      e.target.value = formatarCPF(e.target.value);
    });

    form.addEventListener('submit', async e => {
      e.preventDefault();

      const nome = form.nome.value.trim();
      const tipo = [...tipoRadios].find(r => r.checked).value;

      let dadosFuncionario = { nome, tipo };

      if (tipo === 'funcionario') {
        let funcao = funcaoSelect.value;
        if (funcao === 'Outro') {
          funcao = funcaoOutroInput.value.trim();
          if (!funcao) {
            alert('Por favor, especifique a função.');
            return;
          }
        }
        const obra = form.obra.value.trim();
        if (!nome || !funcao || !obra) {
          alert('Por favor, preencha todos os campos obrigatórios.');
          return;
        }
        dadosFuncionario.funcao = funcao;
        dadosFuncionario.obra = obra;
      } else {
        // diarista
        const cpf = form.cpf.value.trim();
        const tipoPix = form.tipoPix.value.trim();
        const chavePix = form.chavePix.value.trim();
        const banco = form.banco.value.trim();
        const valorDiaria = form.valorDiaria.value.trim();
        const obraDiarista = form.obraDiarista.value.trim();

        if (!nome || !cpf || !valorDiaria || !obraDiarista) {
          alert('Por favor, preencha os campos obrigatórios do diarista.');
          return;
        }

        dadosFuncionario.cpf = cpf;
        dadosFuncionario.tipoPix = tipoPix;
        dadosFuncionario.chavePix = chavePix;
        dadosFuncionario.banco = banco;
        dadosFuncionario.valorDiaria = parseFloat(valorDiaria);
        dadosFuncionario.obra = obraDiarista;
      }

      try {
        if (editandoId) {
          await update(ref(db, `funcionarios/${editandoId}`), dadosFuncionario);
          alert('Funcionário atualizado com sucesso!');
          editandoId = null;
        } else {
          const novoRef = ref(db, 'funcionarios');
          const snapshot = await get(novoRef);
          const idNovo = snapshot.exists()
            ? Object.keys(snapshot.val()).length + 1
            : 1;
          await set(ref(db, `funcionarios/${idNovo}`), dadosFuncionario);
          alert('Funcionário cadastrado com sucesso!');
        }

        // Atualiza o set e a lista visual
        nomesSalvosSet.add(nome);
        atualizarListaConsultados();

        form.reset();
        funcaoOutroGroup.style.display = 'none';
        mostrarCamposPorTipo();
        carregarFuncionarios();
      } catch (error) {
        console.error('Erro ao salvar funcionário:', error);
        alert('Erro ao salvar funcionário. Veja o console para detalhes.');
      }
    });

    async function carregarFuncionarios() {
      try {
        const snapshot = await get(ref(db, 'funcionarios'));
        if (snapshot.exists()) {
          funcionarios = snapshot.val();
          montarLista();

          // Atualiza a lista de nomes salvos (caso tenha funcionários no banco)
          Object.values(funcionarios).forEach(f => {
            if (f.nome) nomesSalvosSet.add(f.nome);
          });
          atualizarListaConsultados();
        } else {
          listaFuncionarios.innerHTML = '<p>Nenhum funcionário encontrado.</p>';
        }
      } catch (error) {
        console.error('Erro ao carregar funcionários:', error);
        listaFuncionarios.innerHTML = '<p>Erro ao carregar funcionários.</p>';
      }
    }

    function montarLista() {
      listaFuncionarios.innerHTML = '';
      for (const id in funcionarios) {
        const f = funcionarios[id];
        let info = `Tipo: ${capitalize(f.tipo)}\n`;
        if (f.tipo.toLowerCase() === 'funcionario') {
          info += `Função: ${f.funcao}\nObra: ${f.obra}`;
        } else if (f.tipo.toLowerCase() === 'diarista') {
          info += `CPF: ${f.cpf}\nChave PIX: ${f.chavePix}\nTipo PIX: ${f.tipoPix}\nBanco: ${f.banco}\nValor da diária: R$ ${Number(f.valorDiaria).toFixed(2)}\nObra: ${f.obra}`;
        }

        const card = document.createElement('div');
        card.className = 'funcionario-card';
        card.innerHTML = `
          <div class="funcionario-nome">${f.nome}</div>
          <div class="funcionario-info">${info.replace(/\n/g, '<br>')}</div>
          <div class="btn-actions">
            <button class="btn-editar" data-id="${id}">Editar</button>
            <button class="btn-excluir" data-id="${id}">Excluir</button>
          </div>
        `;
        listaFuncionarios.appendChild(card);
      }

      document.querySelectorAll('.btn-excluir').forEach(btn => {
        btn.onclick = async () => {
          if (prompt('Digite a senha para confirmar exclusão:') !== '1234') {
            alert('Senha incorreta.');
            return;
          }
          const id = btn.getAttribute('data-id');
          try {
            await remove(ref(db, `funcionarios/${id}`));
            alert('Funcionário excluído com sucesso!');
            // Remove do set também
            if(funcionarios[id] && funcionarios[id].nome){
              nomesSalvosSet.delete(funcionarios[id].nome);
              atualizarListaConsultados();
            }
            carregarFuncionarios();
          } catch (error) {
            console.error('Erro ao excluir funcionário:', error);
            alert('Erro ao excluir funcionário. Veja o console para detalhes.');
          }
        };
      });

      document.querySelectorAll('.btn-editar').forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute('data-id');
          const f = funcionarios[id];
          if (!f) return;

          editandoId = id;
          form.nome.value = f.nome || '';
          if (f.tipo.toLowerCase() === 'funcionario') {
            form.tipo.value = 'funcionario';
            funcaoSelect.value = f.funcao || '';
            if (['Ajudante Prático','Oficial','Oficial Pleno','Oficial Polivalente','Encarregado'].includes(f.funcao)) {
              funcaoOutroGroup.style.display = 'none';
              funcaoOutroInput.required = false;
            } else {
              funcaoSelect.value = 'Outro';
              funcaoOutroGroup.style.display = 'block';
              funcaoOutroInput.value = f.funcao || '';
              funcaoOutroInput.required = true;
            }
            funcionarioCampos.style.display = 'block';
            diaristaCampos.style.display = 'none';
            form.obra.value = f.obra || '';
          } else {
            form.tipo.value = 'diarista';
            funcionarioCampos.style.display = 'none';
            diaristaCampos.style.display = 'block';

            form.cpf.value = f.cpf || '';
            form.tipoPix.value = f.tipoPix || '';
            form.chavePix.value = f.chavePix || '';
            form.banco.value = f.banco || '';
            form.valorDiaria.value = f.valorDiaria || '';
            form.obraDiarista.value = f.obra || '';
          }
        };
      });
    }

    function capitalize(text) {
      if (!text) return '';
      return text.charAt(0).toUpperCase() + text.slice(1).toLowerCase();
    }

    mostrarCamposPorTipo();
    carregarFuncionarios();

  </script>
</body>
</html>
