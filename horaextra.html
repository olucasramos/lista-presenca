<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hora Extra</title>
<style>
  * { box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #2980b9, #6dd5fa);
    color: #fff;
    margin: 0;
    min-height: 100vh;
    padding: 20px 15px 60px 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  header {
    width: 100%;
    max-width: 400px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    justify-content: flex-start;
  }
  a.btn-voltar {
    cursor: pointer;
    background-color: #154360;
    color: white;
    text-decoration: none;
    padding: 8px 16px;
    border-radius: 12px;
    font-weight: 600;
    box-shadow: 0 4px 10px rgba(21,67,96,0.7);
    transition: background-color 0.25s ease, box-shadow 0.25s ease;
    user-select: none;
  }
  a.btn-voltar:hover {
    background-color: #0e2a48;
    box-shadow: 0 6px 14px rgba(14, 42, 72, 0.9);
  }
  h1 { 
    font-size: 2.4rem;
    margin: 0 0 20px 0;
    text-shadow: 0 2px 6px rgba(0,0,0,0.25);
    user-select: none;
    text-align: center;
  }
  #dataSelecionada {
    display: block;
    font-size: 1.1rem;
    margin: 0 auto 20px auto;
    font-weight: 600;
    text-align: center;
    user-select: none;
    max-width: 400px;
    width: 100%;
    padding: 8px 10px;
    border-radius: 10px;
    border: none;
    outline: none;
    cursor: pointer;
    color: #154360;
  }
  .funcionario-card {
    background-color: rgba(21, 67, 96, 0.85);
    border-radius: 12px;
    padding: 18px 20px;
    margin-bottom: 18px;
    width: 100%;
    max-width: 400px;
    box-shadow: 0 6px 14px rgba(21, 67, 96, 0.7);
    user-select: none;
  }
  .funcionario-nome {
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .hora-extra-checkbox {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    cursor: pointer;
    vertical-align: middle;
    appearance: none;
    border: 2px solid #fff;
    position: relative;
    transition: all 0.2s ease;
  }
  .hora-extra-checkbox:checked {
    background-color: #fff;
  }
  .hora-extra-checkbox:checked::after {
    content: '';
    position: absolute;
    top: 4px;
    left: 4px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: #2980b9;
  }
  .hora-extra-group, .qtd-horas-group {
    display: none;
    margin-top: 10px;
    gap: 12px;
  }
  .hora-extra-group label, .qtd-horas-group label {
    cursor: pointer;
    user-select: none;
    margin-right: 10px;
  }
  select {
    cursor: pointer;
    font-size: 1.1rem;
    padding: 2px 6px;
  }
  .btn-salvar {
    background-color: #4caf50;
    padding: 15px 28px;
    border-radius: 12px;
    font-size: 1.2rem;
    font-weight: 600;
    color: white;
    border: none;
    box-shadow: 0 5px 12px rgba(76, 175, 80, 0.7);
    cursor: pointer;
    transition: background-color 0.25s ease, box-shadow 0.25s ease;
    display: block;
    margin: 20px auto 30px auto;
    max-width: 280px;
  }
  .btn-salvar:hover {
    background-color: #388e3c;
    box-shadow: 0 7px 18px rgba(56, 142, 60, 0.9);
  }
  footer {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: rgba(21, 67, 96, 0.9);
    color: #ddd;
    text-align: center;
    font-size: 0.85rem;
    padding: 8px 0;
    user-select: none;
    box-shadow: 0 -2px 6px rgba(0,0,0,0.3);
  }
</style>
</head>
<body>

<header>
  <a href="index.html" class="btn-voltar">⬅ Voltar</a>
</header>

<h1>Hora Extra</h1>
<input type="date" id="dataSelecionada" />

<div id="listaFuncionarios"></div>

<button class="btn-salvar" id="btnSalvar">Salvar Hora Extra</button>

<footer>Desenvolvido por Lucas Ramos Aragão</footer>

<script type="module">
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
import { app } from "./firebase.js";

const db = getDatabase(app);
const listaFuncionarios = document.getElementById("listaFuncionarios");
const dataSelecionadaInput = document.getElementById("dataSelecionada");
const btnSalvar = document.getElementById("btnSalvar");

// Data de hoje
function definirDataHoje() {
  const hoje = new Date();
  const yyyy = hoje.getFullYear();
  const mm = String(hoje.getMonth() + 1).padStart(2,'0');
  const dd = String(hoje.getDate()).padStart(2,'0');
  dataSelecionadaInput.value = `${yyyy}-${mm}-${dd}`;
}

// Carregar funcionários
async function carregarFuncionarios() {
  try {
    const snapshot = await get(ref(db, 'funcionarios'));
    if (snapshot.exists()) {
      const funcionarios = snapshot.val();
      montarCards(funcionarios);
    } else {
      listaFuncionarios.innerHTML = '<p>Nenhum funcionário encontrado.</p>';
    }
  } catch (error) {
    console.error('Erro ao carregar funcionários:', error);
    listaFuncionarios.innerHTML = '<p>Erro ao carregar funcionários.</p>';
  }
}

// Montar cards
function montarCards(funcionarios) {
  listaFuncionarios.innerHTML = '';
  const listaOrdenada = Object.entries(funcionarios)
    .filter(([, f]) => f.tipo.toLowerCase() === 'funcionario')
    .sort(([, a], [, b]) => a.nome.localeCompare(b.nome, 'pt-BR', {sensitivity:'base'}));

  for (const [id, f] of listaOrdenada) {
    const card = document.createElement('div');
    card.classList.add('funcionario-card');

    card.innerHTML = `
      <div class="funcionario-nome">
        ${f.nome}
        <input type="checkbox" class="hora-extra-checkbox">
      </div>
      <div class="hora-extra-group">
        <label><input type="checkbox" class="percentual-checkbox"> 100%</label>
        <label><input type="checkbox" class="percentual-checkbox"> 50%</label>
      </div>
      <div class="qtd-horas-group">
        <label>Quantidade de horas:
          <select class="qtd-horas">
            ${Array.from({length:12},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join('')}
          </select>
        </label>
      </div>
    `;

    const checkbox = card.querySelector('.hora-extra-checkbox');
    const grupoPercentual = card.querySelector('.hora-extra-group');
    const grupoHoras = card.querySelector('.qtd-horas-group');
    const percentualCheckboxes = card.querySelectorAll('.percentual-checkbox');

    // Mostrar grupo percentual ao marcar checkbox
    checkbox.addEventListener('change', () => {
      grupoPercentual.style.display = checkbox.checked ? 'flex' : 'none';
      if (!checkbox.checked) grupoHoras.style.display = 'none';
    });

    // Mostrar quantidade de horas após escolher percentual
    percentualCheckboxes.forEach(cb => {
      cb.addEventListener('change', () => {
        percentualCheckboxes.forEach(other => { if(other!==cb) other.checked=false; });
        grupoHoras.style.display = cb.checked ? 'block' : 'none';
      });
    });

    card.dataset.id = id;
    listaFuncionarios.appendChild(card);
  }
}

// Salvar hora extra
btnSalvar.addEventListener('click', async () => {
  const data = dataSelecionadaInput.value;
  if (!data) { alert('Selecione a data.'); return; }

  const cards = document.querySelectorAll('.funcionario-card');
  for (const card of cards) {
    const id = card.dataset.id;
    const checkbox = card.querySelector('.hora-extra-checkbox');
    if (!checkbox.checked) continue;

    const percentualCheckbox = card.querySelector('.percentual-checkbox:checked');
    if(!percentualCheckbox){ alert(`Selecione percentual para ${card.querySelector('.funcionario-nome').textContent.trim()}`); return; }
    const percentual = percentualCheckbox.nextSibling.textContent.trim().replace('%','');

    const qtdHoras = parseInt(card.querySelector('.qtd-horas').value);

    await set(ref(db, `horaextra/${data}/${id}`), {
      percentual,
      quantidadeHoras: qtdHoras
    });
  }

  alert('Horas extras salvas com sucesso!');
});

definirDataHoje();
carregarFuncionarios();
</script>

</body>
</html>
