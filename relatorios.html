<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rios</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>üìä Relat√≥rios</h1>

    <section>
        <h2>Relat√≥rio de Diaristas</h2>
        <label>Data Inicial: <input type="date" id="dataInicioD"></label>
        <label>Data Final: <input type="date" id="dataFimD"></label>
        <button id="gerarDiaristas" class="btn">Gerar Relat√≥rio</button>
        <div id="resultadoDiaristas"></div>
    </section>

    <section>
        <h2>Relat√≥rio de Faltas</h2>
        <label>Tipo:
            <select id="tipoFaltas">
                <option value="todos">Todos</option>
                <option value="funcionario">Funcion√°rios</option>
                <option value="diarista">Diaristas</option>
            </select>
        </label>
        <label>Data Inicial: <input type="date" id="dataInicioF"></label>
        <label>Data Final: <input type="date" id="dataFimF"></label>
        <button id="gerarFaltas" class="btn">Gerar Relat√≥rio</button>
        <div id="resultadoFaltas"></div>
    </section>

    <a href="index.html" class="btn btn-voltar">‚¨Ö Voltar</a>

    <script type="module">
        import { db, ref, get } from './firebase.js';

        // Fun√ß√£o auxiliar para filtrar datas
        function estaNoPeriodo(data, inicio, fim) {
            const d = new Date(data.split('/').reverse().join('-'));
            return d >= new Date(inicio) && d <= new Date(fim);
        }

        // Relat√≥rio de Diaristas
        document.getElementById("gerarDiaristas").addEventListener("click", async () => {
            const inicio = document.getElementById("dataInicioD").value;
            const fim = document.getElementById("dataFimD").value;
            if (!inicio || !fim) return alert("Selecione o per√≠odo!");

            const funcionariosSnap = await get(ref(db, 'funcionarios'));
            const chamadasSnap = await get(ref(db, 'chamadas'));
            if (!funcionariosSnap.exists() || !chamadasSnap.exists()) {
                return alert("N√£o h√° dados suficientes.");
            }

            const funcionarios = funcionariosSnap.val();
            const chamadas = chamadasSnap.val();
            let relatorio = {};

            for (let data in chamadas) {
                if (estaNoPeriodo(data, inicio, fim)) {
                    for (let id in chamadas[data]) {
                        const f = funcionarios[id];
                        if (f && f.tipo === 'diarista' && chamadas[data][id].status === 'presente') {
                            if (!relatorio[id]) relatorio[id] = { nome: f.nome, dias: 0, diaria: parseFloat(f.valorDiaria || 0) };
                            relatorio[id].dias++;
                        }
                    }
                }
            }

            let html = "<ul>";
            for (let id in relatorio) {
                const r = relatorio[id];
                html += `<li>${r.nome}: ${r.dias} dias √ó R$ ${r.diaria.toFixed(2)} = <strong>R$ ${(r.dias * r.diaria).toFixed(2)}</strong></li>`;
            }
            html += "</ul>";
            document.getElementById("resultadoDiaristas").innerHTML = html || "<p>Nenhum registro encontrado.</p>";
        });

        // Relat√≥rio de Faltas
        document.getElementById("gerarFaltas").addEventListener("click", async () => {
            const inicio = document.getElementById("dataInicioF").value;
            const fim = document.getElementById("dataFimF").value;
            const tipoFiltro = document.getElementById("tipoFaltas").value;

            if (!inicio || !fim) return alert("Selecione o per√≠odo!");

            const funcionariosSnap = await get(ref(db, 'funcionarios'));
            const chamadasSnap = await get(ref(db, 'chamadas'));
            if (!funcionariosSnap.exists() || !chamadasSnap.exists()) {
                return alert("N√£o h√° dados suficientes.");
            }

            const funcionarios = funcionariosSnap.val();
            const chamadas = chamadasSnap.val();
            let relatorio = {};

            for (let data in chamadas) {
                if (estaNoPeriodo(data, inicio, fim)) {
                    for (let id in chamadas[data]) {
                        const f = funcionarios[id];
                        if (f && (tipoFiltro === 'todos' || f.tipo === tipoFiltro) && chamadas[data][id].status === 'falta') {
                            if (!relatorio[id]) relatorio[id] = { nome: f.nome, faltas: [] };
                            relatorio[id].faltas.push(data);
                        }
                    }
                }
            }

            let html = "<ul>";
            for (let id in relatorio) {
                const r = relatorio[id];
                html += `<li>${r.nome}: ${r.faltas.length} faltas (${r.faltas.join(', ')})</li>`;
            }
            html += "</ul>";
            document.getElementById("resultadoFaltas").innerHTML = html || "<p>Nenhum registro encontrado.</p>";
        });
    </script>
</body>
</html>
