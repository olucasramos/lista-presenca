<script type="module">
import { getDatabase, ref, get, remove } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
import { app } from "./firebase.js";

const db = getDatabase(app);

const faltasTipo = document.getElementById('faltasTipo');
const faltasDataInicio = document.getElementById('faltasDataInicio');
const faltasDataFim = document.getElementById('faltasDataFim');
const btnGerarFaltas = document.getElementById('btnGerarFaltas');

const listaFuncionario = document.getElementById('listaFuncionario');
const btnGerarLista = document.getElementById('btnGerarLista');

const pagamentoDataInicio = document.getElementById('pagamentoDataInicio');
const pagamentoDataFim = document.getElementById('pagamentoDataFim');
const btnGerarPagamento = document.getElementById('btnGerarPagamento');

const horaExtraDataInicio = document.getElementById('horaExtraDataInicio');
const horaExtraDataFim = document.getElementById('horaExtraDataFim');
const btnGerarHoraExtra = document.getElementById('btnGerarHoraExtra');

const excluirDataInicio = document.getElementById('excluirDataInicio');
const excluirDataFim = document.getElementById('excluirDataFim');
const btnExcluirChamada = document.getElementById('btnExcluirChamada');

const excluirHoraExtraInicio = document.getElementById('excluirHoraExtraInicio');
const excluirHoraExtraFim = document.getElementById('excluirHoraExtraFim');
const btnExcluirHoraExtra = document.getElementById('btnExcluirHoraExtra');

const resultado = document.getElementById('resultado');
const btnEnviarWhats = document.getElementById('btnEnviarWhats');

let funcionariosCache = {};
let textoRelatorioAtual = '';

// --- Carregar funcion√°rios ---
async function carregarFuncionarios() {
  try {
    const snapshot = await get(ref(db, 'funcionarios'));
    if (snapshot.exists()) {
      funcionariosCache = snapshot.val();
      atualizarListaFuncionarios();
    } else {
      funcionariosCache = {};
      listaFuncionario.innerHTML = '<option value="todos">Nenhum funcion√°rio</option>';
    }
  } catch (error) {
    console.error('Erro ao carregar funcion√°rios:', error);
    listaFuncionario.innerHTML = '<option value="todos">Erro ao carregar</option>';
  }
}

function atualizarListaFuncionarios() {
  listaFuncionario.innerHTML = '<option value="todos">Todos</option>';
  Object.entries(funcionariosCache).forEach(([id, f]) => {
    listaFuncionario.innerHTML += `<option value="${id}">${f.nome}</option>`;
  });
}

function formatarDataDMY(dataISO) {
  if (!dataISO) return '-';
  const [ano, mes, dia] = dataISO.split('-');
  return `${dia}/${mes}/${ano}`;
}

function scrollParaResultado() {
  resultado.scrollIntoView({ behavior: 'smooth' });
}

// --- Relat√≥rio de Faltas ---
btnGerarFaltas.addEventListener('click', async () => {
  const inicio = faltasDataInicio.value;
  const fim = faltasDataFim.value;
  const tipo = faltasTipo.value;

  if (!inicio || !fim) { alert('Selecione o intervalo de datas.'); return; }
  if (fim < inicio) { alert('Data fim n√£o pode ser menor que in√≠cio.'); return; }

  try {
    const snap = await get(ref(db, 'chamada'));
    if (!snap.exists()) { resultado.textContent = 'Nenhum registro de chamada.'; return; }

    const chamadas = snap.val();
    let texto = `üìã *Relat√≥rio de Faltas* (${formatarDataDMY(inicio)} at√© ${formatarDataDMY(fim)})\n\n`;

    for (const data in chamadas) {
      if (data < inicio || data > fim) continue;

      for (const [idFunc, registro] of Object.entries(chamadas[data])) {
        const func = funcionariosCache[idFunc];
        if (!func) continue;
        if (tipo !== 'todos' && func.tipo !== tipo) continue;
        if (registro.status === 'falta') {
          texto += `‚ùå ${func.nome} - ${formatarDataDMY(data)}\n`;
        }
      }
    }

    if (texto.trim().endsWith(')')) texto += 'Nenhuma falta encontrada no per√≠odo.';
    resultado.textContent = texto;
    textoRelatorioAtual = texto;
    scrollParaResultado();

  } catch (err) {
    console.error(err);
    resultado.textContent = 'Erro ao gerar relat√≥rio de faltas.';
  }
});

// --- Dados do Funcion√°rio ---
btnGerarLista.addEventListener('click', () => {
  const id = listaFuncionario.value;
  let texto = 'üßë *Dados de Funcion√°rios*\n\n';

  if (id === 'todos') {
    Object.values(funcionariosCache).forEach(f => {
      texto += `üë§ ${f.nome}\nCPF: ${f.cpf || '-'}\nCargo: ${f.tipo || '-'}\n\n`;
    });
  } else {
    const f = funcionariosCache[id];
    texto += `üë§ ${f.nome}\nCPF: ${f.cpf || '-'}\nCargo: ${f.tipo || '-'}\n`;
  }

  resultado.textContent = texto;
  textoRelatorioAtual = texto;
  scrollParaResultado();
});

// --- Relat√≥rio de Pagamento Diarista ---
btnGerarPagamento.addEventListener('click', async () => {
  const inicio = pagamentoDataInicio.value;
  const fim = pagamentoDataFim.value;

  if (!inicio || !fim) { alert('Selecione as datas.'); return; }
  if (fim < inicio) { alert('Data fim n√£o pode ser menor que in√≠cio.'); return; }

  try {
    const snap = await get(ref(db, 'chamada'));
    if (!snap.exists()) { resultado.textContent = 'Nenhum registro de chamada.'; return; }

    const chamadas = snap.val();
    let texto = `üí∞ *Relat√≥rio de Pagamento Diaristas* (${formatarDataDMY(inicio)} at√© ${formatarDataDMY(fim)})\n\n`;

    let valores = {};

    for (const data in chamadas) {
      if (data < inicio || data > fim) continue;

      for (const [idFunc, registro] of Object.entries(chamadas[data])) {
        const func = funcionariosCache[idFunc];
        if (!func || func.tipo !== 'diarista') continue;
        if (registro.status === 'presenca') {
          valores[idFunc] = (valores[idFunc] || 0) + (func.valorDia || 0);
        }
      }
    }

    for (const [id, total] of Object.entries(valores)) {
      texto += `üë§ ${funcionariosCache[id].nome}: R$ ${total.toFixed(2)}\n`;
    }

    if (Object.keys(valores).length === 0) texto += 'Nenhum pagamento encontrado no per√≠odo.';
    resultado.textContent = texto;
    textoRelatorioAtual = texto;
    scrollParaResultado();

  } catch (err) {
    console.error(err);
    resultado.textContent = 'Erro ao gerar relat√≥rio de pagamento.';
  }
});

// --- Relat√≥rio de Hora Extra (j√° existia) ---
btnGerarHoraExtra.addEventListener('click', async () => {
  const inicio = horaExtraDataInicio.value;
  const fim = horaExtraDataFim.value;

  resultado.textContent = '';
  if (!inicio || !fim) { alert('Selecione a data de in√≠cio e fim'); return; }
  if (fim < inicio) { alert('Data fim n√£o pode ser menor que data in√≠cio.'); return; }

  try {
    const horaExtraSnap = await get(ref(db, 'horaextra'));
    const funcionariosSnap = await get(ref(db, 'funcionarios'));
    if (!horaExtraSnap.exists() || !funcionariosSnap.exists()) {
      resultado.textContent = 'N√£o h√° dados suficientes para gerar o relat√≥rio.';
      return;
    }

    const horaExtra = horaExtraSnap.val();
    const funcionarios = funcionariosSnap.val();

    let texto = `‚è±Ô∏è *Relat√≥rio de Hora Extra* (${formatarDataDMY(inicio)} at√© ${formatarDataDMY(fim)})\n\n`;

    for (const [idFunc, f] of Object.entries(funcionarios)) {
      let horas100 = 0;
      let horas50 = 0;
      let datas = [];

      for (const data in horaExtra) {
        if (data < inicio || data > fim) continue;
        const dia = horaExtra[data][idFunc];
        if (!dia) continue;

        const qtd = dia.quantidadeHoras || 0;
        if (dia.percentual === "100") horas100 += qtd;
        else if (dia.percentual === "50") horas50 += qtd;
        datas.push(`${formatarDataDMY(data)} (${dia.percentual}%)`);
      }

      if (horas100 + horas50 === 0) continue;

      texto += `üë§ *${f.nome}*\n`;
      texto += `Horas 100%: *${horas100}*\nHoras 50%: *${horas50}*\n`;
      texto += `Dias: ${datas.join(', ')}\n\n`;
    }

    if (texto.trim().endsWith(')')) {
      texto += 'Nenhuma hora extra registrada no per√≠odo.';
    }

    resultado.textContent = texto.trim();
    textoRelatorioAtual = texto.trim();
    scrollParaResultado();

  } catch (error) {
    console.error('Erro ao gerar relat√≥rio de hora extra:', error);
    resultado.textContent = 'Erro ao gerar relat√≥rio de hora extra.';
  }
});

// --- Excluir Chamada ---
btnExcluirChamada.addEventListener('click', async () => {
  const inicio = excluirDataInicio.value;
  const fim = excluirDataFim.value;

  if (!inicio || !fim) { alert('Selecione as datas.'); return; }
  if (fim < inicio) { alert('Data fim n√£o pode ser menor que in√≠cio.'); return; }
  if (!confirm(`Deseja realmente excluir as chamadas entre ${inicio} e ${fim}?`)) return;

  try {
    const snap = await get(ref(db, 'chamada'));
    if (!snap.exists()) { alert('N√£o h√° registros de chamada.'); return; }

    const chamadas = snap.val();
    let excluidos = 0;

    for (const data in chamadas) {
      if (data >= inicio && data <= fim) {
        await remove(ref(db, `chamada/${data}`));
        excluidos++;
      }
    }

    if (excluidos > 0) alert(`Exclu√≠das chamadas de ${excluidos} dia(s).`);
    else alert('Nenhum registro encontrado no per√≠odo.');

  } catch (err) {
    console.error(err);
    alert('Erro ao excluir chamadas.');
  }
});

// --- Excluir Hora Extra (j√° existia) ---
btnExcluirHoraExtra.addEventListener('click', async () => {
  const inicio = excluirHoraExtraInicio.value;
  const fim = excluirHoraExtraFim.value;

  if (!inicio || !fim) { alert('Selecione a data de in√≠cio e fim'); return; }
  if (fim < inicio) { alert('Data fim n√£o pode ser menor que data in√≠cio.'); return; }
  if (!confirm(`Deseja realmente excluir todas as horas extras entre ${inicio} e ${fim}?`)) return;

  try {
    const horaExtraSnap = await get(ref(db, 'horaextra'));
    if (!horaExtraSnap.exists()) { alert('N√£o h√° registros de hora extra para excluir.'); return; }

    const horaExtra = horaExtraSnap.val();
    let excluidos = 0;

    for (const data in horaExtra) {
      if (data >= inicio && data <= fim) {
        await remove(ref(db, `horaextra/${data}`));
        excluidos++;
      }
    }

    if (excluidos > 0) alert(`Exclu√≠das horas extras de ${excluidos} dia(s).`);
    else alert('N√£o havia registros de hora extra no per√≠odo selecionado.');

  } catch (error) {
    console.error('Erro ao excluir horas extras:', error);
    alert('Erro ao excluir horas extras.');
  }
});

// --- Envio para WhatsApp ---
btnEnviarWhats.addEventListener('click', () => {
  if (!textoRelatorioAtual) { alert('Gere um relat√≥rio antes de enviar.'); return; }
  const textoEncoded = encodeURIComponent(textoRelatorioAtual);
  window.open(`https://wa.me/?text=${textoEncoded}`, '_blank');
});

carregarFuncionarios();
</script>
